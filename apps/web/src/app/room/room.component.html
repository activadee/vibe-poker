<div class="room">
  <h2>Room {{ roomId() }}</h2>

  @if (error()) {
    <div class="error">
      {{ error() }}
      <div class="actions">
        <a routerLink="/" class="btn">Create a new room</a>
      </div>
    </div>
  }

  @if (!joined()) {
    <div class="join">
      <label>
        Your name
        <input [(ngModel)]="name" (keyup.enter)="join()" placeholder="Alice" />
      </label>
      <label class="check">
        <input type="checkbox" [(ngModel)]="joinAsObserver" />
        Join as observer (cannot vote)
      </label>
      <button class="btn primary" (click)="join()">Join Room</button>
    </div>
  }

  @if (joined()) {
    <div class="story">
      <h3>Current Story</h3>
      @if (myRole() === 'host') {
        <div class="story-editor">
          <label>
            Title
            <input [(ngModel)]="storyTitleModel" placeholder="Enter story title" />
          </label>
          <label>
            Notes
            <textarea [(ngModel)]="storyNotesModel" rows="3" placeholder="Optional notes"></textarea>
          </label>
          <div class="actions">
            <button class="btn" [disabled]="!storyTitleModel.trim()" (click)="saveStory()">Save</button>
          </div>
        </div>
      } @else {
        <div class="story-view">
          <div class="title">{{ (story()?.title || '—') }}</div>
          @if (story()?.notes) {
            <pre class="notes">{{ story()?.notes }}</pre>
          }
        </div>
      }
    </div>
    <div class="room-actions">
      <button class="btn secondary" (click)="leave()">Leave Room</button>
    </div>
    <div class="share">
      <p>Share this link with your team:</p>
      <div class="link">
        <code>{{ url }}</code>
        <button (click)="copyLink()">Copy Link</button>
      </div>
      @if(copied()) {
        <p class="copied">Link copied!</p>
      }
    </div>

    <div class="participants">
      <h3>Participants</h3>
      <div class="progress-pill" *ngIf="voteTotal() > 0">
        {{ voteCount() }}/{{ voteTotal() }} voted
      </div>
      @if (revealed() && stats()) {
        <div class="results">
          <div class="stats-pill">Avg {{ stats()!.avg.toFixed(1) }} • Median {{ stats()!.median.toFixed(1) }}</div>
        </div>
      }
      <ul>
        @for (p of participants(); track p.id) {
          <li>
            <span class="name">{{ p.name }}</span>
            <span class="role">{{ p.role }}</span>
            <span class="badge voted" *ngIf="hasVoted(p)">Voted</span>
            <span class="vote" *ngIf="revealed(); else hiddenVote">{{ votes()[p.id] ?? '—' }}</span>
            <ng-template #hiddenVote>
              <span class="vote muted">—</span>
            </ng-template>
          </li>
        }
      </ul>
    </div>

    <div class="voting">
      <h3>Vote</h3>
      <app-vote-cards
        [values]="deckValues()"
        [disabled]="myRole() === 'observer'"
        (valueSelected)="castVote($event)"
      />
    </div>

    @if (myRole() === 'host') {
      <div class="host-controls">
        <h3>Host Controls</h3>
        <div class="deck-select">
          <label>
            Deck Preset
            <select [ngModel]="deckId()" (ngModelChange)="changeDeck($event)">
              <option value="fibonacci">Fibonacci</option>
              <option value="tshirt">T‑Shirt sizes</option>
            </select>
          </label>
        </div>
        <div class="controls">
          @if (!revealed()) {
            <ng-container>
              <button class="btn primary" (click)="reveal()">Reveal</button>
              <button class="btn" (click)="resetVotes()">Reset</button>
            </ng-container>
          } @else {
            <ng-container>
              <!-- FR-014: After reveal show prominent Revote CTA -->
              <button class="btn primary" (click)="revote()">Revote</button>
            </ng-container>
          }
        </div>
      </div>
    }
  }
</div>
