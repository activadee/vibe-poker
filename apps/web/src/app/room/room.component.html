<div class="min-h-screen px-4 py-8 max-w-5xl mx-auto">
  <header class="mb-4">
    <h2 class="text-xl font-semibold tracking-tight text-slate-900">
      Room {{ roomId() }}
    </h2>
  </header>

  @if (error()) {
  <div
    class="rounded-md border border-red-200 bg-red-50 text-red-800 p-4 mb-4 error"
  >
    <div class="flex items-start justify-between gap-4">
      <p class="text-sm">{{ error() }}</p>
      <a routerLink="/" appUiButton variant="secondary">Create a new room</a>
    </div>
  </div>
  } @if (showJoinModal()) {
  <div
    class="modal-backdrop"
    role="dialog"
    aria-modal="true"
    aria-labelledby="joinDialogTitle"
    aria-describedby="joinDialogDesc"
  >
    <div class="modal">
      <app-ui-card class="block">
        <h3 id="joinDialogTitle" class="text-base font-semibold text-slate-900">Join Room</h3>
        <p id="joinDialogDesc" class="mt-1 text-xs text-slate-500">Your display name will be visible to others. Observers cannot vote.</p>
        <div class="mt-3">
          <label for="joinName" class="block text-sm font-medium text-slate-700"
            >Your name</label
          >
          <input
            id="joinName"
            appUiInput
            [(ngModel)]="name"
            (keyup.enter)="join()"
            autofocus
            placeholder="Alice"
          />
        </div>
        <div class="mt-3 flex items-center gap-2 text-sm text-slate-700">
          <input
            id="joinObserver"
            appUiCheckbox
            type="checkbox"
            [(ngModel)]="joinAsObserver"
          />
          <label for="joinObserver" class="cursor-pointer select-none"
            >Join as observer (cannot vote)</label
          >
        </div>
        <div class="mt-4 flex items-center justify-end gap-2">
          <a routerLink="/" appUiButton variant="secondary">Cancel</a>
          <button appUiButton (click)="join()">Join Room</button>
        </div>
      </app-ui-card>
    </div>
  </div>
  } @if (joined()) {
  <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="lg:col-span-2 space-y-4">
      <!-- Story -->
      <app-ui-card class="block">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold text-slate-900">Current Story</h3>
        </div>
        @if (myRole() === 'host') {
        <div class="mt-3 grid grid-cols-1 gap-3">
          <div>
            <label
              for="storyTitle"
              class="block text-sm font-medium text-slate-700"
              >Title</label
            >
            <input
              id="storyTitle"
              appUiInput
              [(ngModel)]="storyTitleModel"
              placeholder="Enter story title"
            />
          </div>
          <div>
            <label
              for="storyNotes"
              class="block text-sm font-medium text-slate-700"
              >Notes</label
            >
            <textarea
              id="storyNotes"
              appUiInput
              [(ngModel)]="storyNotesModel"
              rows="3"
              placeholder="Optional notes"
            ></textarea>
          </div>
          <div class="flex justify-end">
            <button
              appUiButton
              variant="secondary"
              [disabled]="!storyTitleModel.trim()"
              (click)="saveStory()"
            >
              Save
            </button>
          </div>
        </div>
        } @else {
        <div class="mt-3">
          <div class="font-medium text-slate-900">
            {{ story()?.title || '—' }}
          </div>
          @if (story()?.notes) {
          <pre class="mt-2 text-sm text-slate-600 whitespace-pre-wrap">{{
            story()?.notes
          }}</pre>
          }
        </div>
        }
      </app-ui-card>

      <!-- Voting -->
      <app-ui-card class="block">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold text-slate-900">Vote</h3>
        </div>
        <app-vote-cards
          [values]="deckValues()"
          [disabled]="myRole() === 'observer'"
          (valueSelected)="castVote($event)"
        />
      </app-ui-card>
    </div>

    <div class="space-y-4">
      <!-- Room actions -->
      <app-ui-card class="block">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-sm text-slate-600">Share this room:</p>
            <code class="block mt-1 text-xs text-slate-700 truncate">{{
              url
            }}</code>
          </div>
        </div>
        @if(copied()) {
        <p class="mt-2 text-xs text-green-700" role="status" aria-live="polite">Link copied!</p>
        }
        <div class="mt-4 flex justify-end gap-2">
          <button appUiButton size="sm" variant="secondary" (click)="copyLink()">
            Copy Invite
          </button>
          <button appUiButton variant="secondary" size="sm" (click)="leave()">
            Leave Room
          </button>
        </div>
      </app-ui-card>

      <!-- Participants -->
      <app-ui-card class="block participants">
        <div class="flex items-center justify-between">
          <h3 class="text-base font-semibold text-slate-900">Participants</h3>
          @if (voteTotal() > 0) {
          <div
            class="progress-pill inline-flex items-center rounded-full px-3 py-1 text-xs bg-slate-100 text-slate-700"
            role="status" aria-live="polite"
          >
            {{ voteCount() }}/{{ voteTotal() }} voted
          </div>
          }
        </div>
        @if (revealed() && stats()) {
        <div class="mt-2 results">
          <div
            class="stats-pill inline-flex items-center rounded-full px-3 py-1 text-xs bg-violet-100 text-violet-800 font-semibold"
          >
            Avg {{ stats()!.avg.toFixed(1) }} • Median
            {{ stats()!.median.toFixed(1) }}
          </div>
        </div>
        }
        <ul class="mt-3 space-y-2">
          @for (p of participants(); track p.id) {
          <li class="flex items-center justify-between">
            <div class="flex items-center gap-2 min-w-0">
              <span class="truncate">{{ p.name }}</span>
              <span class="role text-slate-500 text-xs">{{ p.role }}</span>
              @if (hasVoted(p)) {<span class="badge voted">Voted</span>}
            </div>
            <div class="text-sm text-slate-700">
              @if (revealed()) {
                <span class="vote">{{ votes()[p.id] }}</span>
              } @else {
                <span class="vote text-slate-400">—</span>
              }
            </div>
          </li>
          }
        </ul>
      </app-ui-card>

      <!-- Host controls -->
      @if (myRole() === 'host') {
      <app-ui-card class="block host-controls">
        <h3 class="text-base font-semibold text-slate-900">Host Controls</h3>
        <div class="mt-3 deck-select">
          <label
            for="deckSelect"
            class="block text-sm font-medium text-slate-700"
            >Deck Preset</label
          >
          <select
            id="deckSelect"
            class="mt-1 block w-full rounded-md border-slate-200 bg-white text-slate-900 shadow-sm focus:border-primary-500 focus:ring-2 focus:ring-primary-500/40"
            [ngModel]="deckId()"
            (ngModelChange)="changeDeck($event)"
          >
            <option value="fibonacci">Fibonacci</option>
            <option value="tshirt">T‑Shirt sizes</option>
          </select>
        </div>
        <div class="mt-4 flex items-center gap-2">
          @if (!revealed()) {
            <button appUiButton (click)="reveal()">Reveal</button>
            <button appUiButton variant="secondary" (click)="resetVotes()">
              Reset
            </button>
          } @else {
            <button appUiButton (click)="revote()">Revote</button>
          }
        </div>
      </app-ui-card>
      }
    </div>
  </section>
  }
</div>
